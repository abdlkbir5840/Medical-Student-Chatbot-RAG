"use strict";var e=require("@huggingface/transformers"),a=require("phonemizer"),n=require("path"),r=require("fs/promises");function t(e){if(e.includes("."))return e;if(e.includes(":")){let[a,n]=e.split(":").map(Number);return 0===n?`${a} o'clock`:n<10?`${a} oh ${n}`:`${a} ${n}`}let a=parseInt(e.slice(0,4),10);if(a<1100||a%1e3<10)return e;let n=e.slice(0,2),r=parseInt(e.slice(2,4),10),t=e.endsWith("s")?"s":"";if(a%1e3>=100&&a%1e3<=999){if(0===r)return`${n} hundred${t}`;if(r<10)return`${n} oh ${r}${t}`}return`${n} ${r}${t}`}function l(e){const a="$"===e[0]?"dollar":"pound";if(isNaN(Number(e.slice(1))))return`${e.slice(1)} ${a}s`;if(!e.includes(".")){let n="1"===e.slice(1)?"":"s";return`${e.slice(1)} ${a}${n}`}const[n,r]=e.slice(1).split("."),t=parseInt(r.padEnd(2,"0"),10);return`${n} ${a}${"1"===n?"":"s"} and ${t} ${"$"===e[0]?1===t?"cent":"cents":1===t?"penny":"pence"}`}function c(e){let[a,n]=e.split(".");return`${a} point ${n.split("").join(" ")}`}const s=new RegExp(`(\\s*[${i=';:,.!?¡¿—…"«»“”(){}[]',i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}]+\\s*)+`,"g");var i;async function o(e,n="a",r=!0){r&&(e=function(e){return e.replace(/[‘’]/g,"'").replace(/«/g,"“").replace(/»/g,"”").replace(/[“”]/g,'"').replace(/\(/g,"«").replace(/\)/g,"»").replace(/、/g,", ").replace(/。/g,". ").replace(/！/g,"! ").replace(/，/g,", ").replace(/：/g,": ").replace(/；/g,"; ").replace(/？/g,"? ").replace(/[^\S \n]/g," ").replace(/  +/," ").replace(/(?<=\n) +(?=\n)/g,"").replace(/\bD[Rr]\.(?= [A-Z])/g,"Doctor").replace(/\b(?:Mr\.|MR\.(?= [A-Z]))/g,"Mister").replace(/\b(?:Ms\.|MS\.(?= [A-Z]))/g,"Miss").replace(/\b(?:Mrs\.|MRS\.(?= [A-Z]))/g,"Mrs").replace(/\betc\.(?! [A-Z])/gi,"etc").replace(/\b(y)eah?\b/gi,"$1e'a").replace(/\d*\.\d+|\b\d{4}s?\b|(?<!:)\b(?:[1-9]|1[0-2]):[0-5]\d\b(?!:)/g,t).replace(/(?<=\d),(?=\d)/g,"").replace(/[$£]\d+(?:\.\d+)?(?: hundred| thousand| (?:[bm]|tr)illion)*\b|[$£]\d+\.\d\d?\b/gi,l).replace(/\d*\.\d+/g,c).replace(/(?<=\d)-(?=\d)/g," to ").replace(/(?<=\d)S/g," S").replace(/(?<=[BCDFGHJ-NP-TV-Z])'?s\b/g,"'S").replace(/(?<=X')S\b/g,"s").replace(/(?:[A-Za-z]\.){2,} [a-z]/g,(e=>e.replace(/\./g,"-"))).replace(/(?<=[A-Z])\.(?=[A-Z])/gi,"-").trim()}(e));const i=function(e,a){const n=[];let r=0;for(const t of e.matchAll(a)){const a=t[0];r<t.index&&n.push({match:!1,text:e.slice(r,t.index)}),a.length>0&&n.push({match:!0,text:a}),r=t.index+a.length}return r<e.length&&n.push({match:!1,text:e.slice(r)}),n}(e,s),o="a"===n?"en-us":"en",g=(await Promise.all(i.map((async({match:e,text:n})=>e?n:(await a.phonemize(n,o)).join(" "))))).join("");let p=g.replace(/kəkˈoːɹoʊ/g,"kˈoʊkəɹoʊ").replace(/kəkˈɔːɹəʊ/g,"kˈəʊkəɹəʊ").replace(/ʲ/g,"j").replace(/r/g,"ɹ").replace(/x/g,"k").replace(/ɬ/g,"l").replace(/(?<=[a-zɹː])(?=hˈʌndɹɪd)/g," ").replace(/ z(?=[;:,.!?¡¿—…"«»“” ]|$)/g,"z");return"a"===n&&(p=p.replace(/(?<=nˈaɪn)ti(?!ː)/g,"di")),p.trim()}const g=Object.freeze({af:{name:"Default",language:"en-us",gender:"Female"},af_bella:{name:"Bella",language:"en-us",gender:"Female"},af_nicole:{name:"Nicole",language:"en-us",gender:"Female"},af_sarah:{name:"Sarah",language:"en-us",gender:"Female"},af_sky:{name:"Sky",language:"en-us",gender:"Female"},am_adam:{name:"Adam",language:"en-us",gender:"Male"},am_michael:{name:"Michael",language:"en-us",gender:"Male"},bf_emma:{name:"Emma",language:"en-gb",gender:"Female"},bf_isabella:{name:"Isabella",language:"en-gb",gender:"Female"},bm_george:{name:"George",language:"en-gb",gender:"Male"},bm_lewis:{name:"Lewis",language:"en-gb",gender:"Male"}});const p=new Map;async function u(e){if(p.has(e))return p.get(e);const a=new Float32Array(await async function(e){if(r?.readFile){const a=n.resolve(__dirname,`../voices/${e}.bin`),{buffer:t}=await r.readFile(a);return t}const a=`https://huggingface.co/onnx-community/Kokoro-82M-ONNX/resolve/main/voices/${e}.bin`;let t;try{t=await caches.open("kokoro-voices");const e=await t.match(a);if(e)return await e.arrayBuffer()}catch(e){console.warn("Unable to open cache",e)}const l=await fetch(a),c=await l.arrayBuffer();if(t)try{await t.put(a,new Response(c,{headers:l.headers}))}catch(e){console.warn("Unable to cache file",e)}return c}(e));return p.set(e,a),a}class d{constructor(e,a){this.model=e,this.tokenizer=a}static async from_pretrained(a,{dtype:n="fp32",device:r=null,progress_callback:t=null}={}){const l=e.StyleTextToSpeech2Model.from_pretrained(a,{progress_callback:t,dtype:n,device:r}),c=e.AutoTokenizer.from_pretrained(a,{progress_callback:t}),s=await Promise.all([l,c]);return new d(...s)}get voices(){return g}list_voices(){console.table(g)}async generate(a,{voice:n="af",speed:r=1}={}){if(!g.hasOwnProperty(n))throw console.error(`Voice "${n}" not found. Available voices:`),console.table(g),new Error(`Voice "${n}" not found. Should be one of: ${Object.keys(g).join(", ")}.`);const t=n.at(0),l=await o(a,t),{input_ids:c}=this.tokenizer(l,{truncation:!0}),s=256*Math.max(c.dims.at(-1)-2,0),i=(await u(n)).slice(s,s+256),p={input_ids:c,style:new e.Tensor("float32",i,[1,256]),speed:new e.Tensor("float32",[r],[1])},{waveform:d}=await this.model(p);return new e.RawAudio(d.data,24e3)}}exports.KokoroTTS=d;
