import{StyleTextToSpeech2Model as e,AutoTokenizer as a,Tensor as n,RawAudio as r}from"@huggingface/transformers";import{phonemize as t}from"phonemizer";import l from"path";import c from"fs/promises";function i(e){if(e.includes("."))return e;if(e.includes(":")){let[a,n]=e.split(":").map(Number);return 0===n?`${a} o'clock`:n<10?`${a} oh ${n}`:`${a} ${n}`}let a=parseInt(e.slice(0,4),10);if(a<1100||a%1e3<10)return e;let n=e.slice(0,2),r=parseInt(e.slice(2,4),10),t=e.endsWith("s")?"s":"";if(a%1e3>=100&&a%1e3<=999){if(0===r)return`${n} hundred${t}`;if(r<10)return`${n} oh ${r}${t}`}return`${n} ${r}${t}`}function s(e){const a="$"===e[0]?"dollar":"pound";if(isNaN(Number(e.slice(1))))return`${e.slice(1)} ${a}s`;if(!e.includes(".")){let n="1"===e.slice(1)?"":"s";return`${e.slice(1)} ${a}${n}`}const[n,r]=e.slice(1).split("."),t=parseInt(r.padEnd(2,"0"),10);return`${n} ${a}${"1"===n?"":"s"} and ${t} ${"$"===e[0]?1===t?"cent":"cents":1===t?"penny":"pence"}`}function o(e){let[a,n]=e.split(".");return`${a} point ${n.split("").join(" ")}`}const g=new RegExp(`(\\s*[${p=';:,.!?¡¿—…"«»“”(){}[]',p.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}]+\\s*)+`,"g");var p;async function u(e,a="a",n=!0){n&&(e=function(e){return e.replace(/[‘’]/g,"'").replace(/«/g,"“").replace(/»/g,"”").replace(/[“”]/g,'"').replace(/\(/g,"«").replace(/\)/g,"»").replace(/、/g,", ").replace(/。/g,". ").replace(/！/g,"! ").replace(/，/g,", ").replace(/：/g,": ").replace(/；/g,"; ").replace(/？/g,"? ").replace(/[^\S \n]/g," ").replace(/  +/," ").replace(/(?<=\n) +(?=\n)/g,"").replace(/\bD[Rr]\.(?= [A-Z])/g,"Doctor").replace(/\b(?:Mr\.|MR\.(?= [A-Z]))/g,"Mister").replace(/\b(?:Ms\.|MS\.(?= [A-Z]))/g,"Miss").replace(/\b(?:Mrs\.|MRS\.(?= [A-Z]))/g,"Mrs").replace(/\betc\.(?! [A-Z])/gi,"etc").replace(/\b(y)eah?\b/gi,"$1e'a").replace(/\d*\.\d+|\b\d{4}s?\b|(?<!:)\b(?:[1-9]|1[0-2]):[0-5]\d\b(?!:)/g,i).replace(/(?<=\d),(?=\d)/g,"").replace(/[$£]\d+(?:\.\d+)?(?: hundred| thousand| (?:[bm]|tr)illion)*\b|[$£]\d+\.\d\d?\b/gi,s).replace(/\d*\.\d+/g,o).replace(/(?<=\d)-(?=\d)/g," to ").replace(/(?<=\d)S/g," S").replace(/(?<=[BCDFGHJ-NP-TV-Z])'?s\b/g,"'S").replace(/(?<=X')S\b/g,"s").replace(/(?:[A-Za-z]\.){2,} [a-z]/g,(e=>e.replace(/\./g,"-"))).replace(/(?<=[A-Z])\.(?=[A-Z])/gi,"-").trim()}(e));const r=function(e,a){const n=[];let r=0;for(const t of e.matchAll(a)){const a=t[0];r<t.index&&n.push({match:!1,text:e.slice(r,t.index)}),a.length>0&&n.push({match:!0,text:a}),r=t.index+a.length}return r<e.length&&n.push({match:!1,text:e.slice(r)}),n}(e,g),l="a"===a?"en-us":"en",c=(await Promise.all(r.map((async({match:e,text:a})=>e?a:(await t(a,l)).join(" "))))).join("");let p=c.replace(/kəkˈoːɹoʊ/g,"kˈoʊkəɹoʊ").replace(/kəkˈɔːɹəʊ/g,"kˈəʊkəɹəʊ").replace(/ʲ/g,"j").replace(/r/g,"ɹ").replace(/x/g,"k").replace(/ɬ/g,"l").replace(/(?<=[a-zɹː])(?=hˈʌndɹɪd)/g," ").replace(/ z(?=[;:,.!?¡¿—…"«»“” ]|$)/g,"z");return"a"===a&&(p=p.replace(/(?<=nˈaɪn)ti(?!ː)/g,"di")),p.trim()}const d=Object.freeze({af:{name:"Default",language:"en-us",gender:"Female"},af_bella:{name:"Bella",language:"en-us",gender:"Female"},af_nicole:{name:"Nicole",language:"en-us",gender:"Female"},af_sarah:{name:"Sarah",language:"en-us",gender:"Female"},af_sky:{name:"Sky",language:"en-us",gender:"Female"},am_adam:{name:"Adam",language:"en-us",gender:"Male"},am_michael:{name:"Michael",language:"en-us",gender:"Male"},bf_emma:{name:"Emma",language:"en-gb",gender:"Female"},bf_isabella:{name:"Isabella",language:"en-gb",gender:"Female"},bm_george:{name:"George",language:"en-gb",gender:"Male"},bm_lewis:{name:"Lewis",language:"en-gb",gender:"Male"}});const m=new Map;async function f(e){if(m.has(e))return m.get(e);const a=new Float32Array(await async function(e){if(c?.readFile){const a=l.resolve(import.meta.dirname??__dirname,`../voices/${e}.bin`),{buffer:n}=await c.readFile(a);return n}const a=`https://huggingface.co/onnx-community/Kokoro-82M-ONNX/resolve/main/voices/${e}.bin`;let n;try{n=await caches.open("kokoro-voices");const e=await n.match(a);if(e)return await e.arrayBuffer()}catch(e){console.warn("Unable to open cache",e)}const r=await fetch(a),t=await r.arrayBuffer();if(n)try{await n.put(a,new Response(t,{headers:r.headers}))}catch(e){console.warn("Unable to cache file",e)}return t}(e));return m.set(e,a),a}class h{constructor(e,a){this.model=e,this.tokenizer=a}static async from_pretrained(n,{dtype:r="fp32",device:t=null,progress_callback:l=null}={}){const c=e.from_pretrained(n,{progress_callback:l,dtype:r,device:t}),i=a.from_pretrained(n,{progress_callback:l}),s=await Promise.all([c,i]);return new h(...s)}get voices(){return d}list_voices(){console.table(d)}async generate(e,{voice:a="af",speed:t=1}={}){if(!d.hasOwnProperty(a))throw console.error(`Voice "${a}" not found. Available voices:`),console.table(d),new Error(`Voice "${a}" not found. Should be one of: ${Object.keys(d).join(", ")}.`);const l=a.at(0),c=await u(e,l),{input_ids:i}=this.tokenizer(c,{truncation:!0}),s=256*Math.max(i.dims.at(-1)-2,0),o=(await f(a)).slice(s,s+256),g={input_ids:i,style:new n("float32",o,[1,256]),speed:new n("float32",[t],[1])},{waveform:p}=await this.model(g);return new r(p.data,24e3)}}export{h as KokoroTTS};
